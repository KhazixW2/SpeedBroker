# 📖 使用手册

## 目录
- [快速开始](#快速开始)
- [命令参考](#命令参考)
- [使用场景](#使用场景)
- [工作流程](#工作流程)
- [结果解读](#结果解读)
- [常见问题](#常见问题)
- [最佳实践](#最佳实践)

---

## 快速开始

### 前提条件

- **Python 版本**: 3.8 或更高
- **操作系统**: Windows / macOS / Linux
- **网络连接**: 用于下载股票数据

### 安装步骤

#### 1. 进入项目目录

```bash
cd d:/workspace/SpeedBroker
```

#### 2. 安装依赖包

```bash
pip install -r requirements.txt
```

**主要依赖包**：
- `pandas` - 数据处理
- `numpy` - 数值计算
- `matplotlib` - 图表绘制
- `yfinance` - 股票数据获取（推荐）
- `akshare` - 中国股票数据获取（备选）

#### 3. 验证安装

```bash
python -c "import pandas, numpy, matplotlib, yfinance; print('安装成功！')"
```

---

## 命令参考

### 基础命令

#### 1. 运行回测系统

```bash
python main.py
```

**说明**：使用默认配置执行完整的回测流程

**输出**：
- 控制台打印回测进度和结果
- 生成图表保存在 `./output/` 目录
- 生成交易日志CSV文件
- 缓存数据保存在 `./data/cache/` 目录

#### 2. 测试数据源

```bash
python test_akshare.py
```

**说明**：诊断数据源连接，测试 akshare 和 yfinance 是否正常

**用途**：
- 排查数据获取问题
- 确认数据源可用性
- 对比不同数据源的数据质量

#### 3. 查看帮助

```bash
python main.py --help
```

（注：当前版本暂不支持命令行参数，所有配置通过 `config.py` 完成）

---

### 高级命令

#### 清理缓存

```bash
# Windows
rmdir /s /q data\cache
mkdir data\cache

# Linux/Mac
rm -rf data/cache/*
```

**说明**：删除所有缓存的股票数据，下次运行将重新下载

**使用场景**：
- 数据已过期，需要更新
- 切换数据源（如从 akshare 切换到 yfinance）
- 数据文件损坏

#### 批量运行回测

```bash
# 示例：测试不同的均线周期组合
# 需要编写脚本修改config.py并多次运行

# batch_backtest.bat (Windows示例)
@echo off
python main.py
pause
```

---

## 使用场景

### 场景 1: 测试单只股票

**目标**：评估某只股票的双均线策略效果

**步骤**：

1. **编辑 config.py**：
```python
DATA_CONFIG = {
    'tickers': ['000001.SZ'],  # 平安银行
    'start_date': '2023-01-01',
    'end_date': '2024-10-01',
    'data_source': 'yfinance',
}

STRATEGY_CONFIG = {
    'strategy_name': 'DualMovingAverage',
    'short_window': 10,
    'long_window': 30,
}
```

2. **运行回测**：
```bash
python main.py
```

3. **查看结果**：
   - 控制台查看性能指标
   - `./output/` 查看可视化图表
   - `./output/` 查看交易日志CSV

---

### 场景 2: 对比不同均线周期

**目标**：找出最佳均线参数组合

**步骤**：

1. **第一次测试** (5日/20日)：
```python
STRATEGY_CONFIG = {
    'short_window': 5,
    'long_window': 20,
}
```
运行：`python main.py`
记录：总收益率、夏普比率、最大回撤

2. **第二次测试** (10日/30日)：
```python
STRATEGY_CONFIG = {
    'short_window': 10,
    'long_window': 30,
}
```
运行：`python main.py`

3. **第三次测试** (20日/60日)：
```python
STRATEGY_CONFIG = {
    'short_window': 20,
    'long_window': 60,
}
```
运行：`python main.py`

4. **对比结果**：选择收益率高、回撤小的参数组合

---

### 场景 3: 测试不同股票

**目标**：在多只股票上验证策略有效性

**示例**：

```python
# 测试1: 平安银行
DATA_CONFIG = {'tickers': ['000001.SZ']}
# 运行并记录结果

# 测试2: 贵州茅台
DATA_CONFIG = {'tickers': ['600519.SH']}
# 运行并记录结果

# 测试3: 招商银行
DATA_CONFIG = {'tickers': ['600036.SH']}
# 运行并记录结果
```

**提示**：当前版本一次只支持单只股票，未来可扩展为批量测试

---

### 场景 4: 不同时间段的稳定性测试

**目标**：验证策略在不同市场环境下的表现

**步骤**：

```python
# 牛市测试 (2020-2021)
DATA_CONFIG = {
    'start_date': '2020-01-01',
    'end_date': '2021-12-31',
}

# 熊市测试 (2022)
DATA_CONFIG = {
    'start_date': '2022-01-01',
    'end_date': '2022-12-31',
}

# 震荡市测试 (2023-2024)
DATA_CONFIG = {
    'start_date': '2023-01-01',
    'end_date': '2024-10-01',
}
```

---

### 场景 5: 调整资金和成本

**目标**：模拟不同资金规模和交易成本对收益的影响

**步骤**：

```python
# 小资金账户 (10万，高手续费)
BACKTEST_CONFIG = {
    'initial_capital': 100000,
    'commission_rate': 0.0003,  # 0.03%
    'stamp_duty_rate': 0.001,   # 0.1%
}

# 大资金账户 (100万，低手续费)
BACKTEST_CONFIG = {
    'initial_capital': 1000000,
    'commission_rate': 0.0001,  # 0.01%
    'stamp_duty_rate': 0.001,   # 0.1%
}
```

---

## 工作流程

### 完整回测流程

```
┌─────────────────┐
│  1. 准备工作    │
│  - 安装依赖     │
│  - 配置参数     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  2. 执行回测    │
│  python main.py │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  3. 程序执行    │
│  ├ 初始化模块   │
│  ├ 获取数据     │
│  ├ 生成信号     │
│  ├ 执行回测     │
│  ├ 分析结果     │
│  └ 生成报告     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  4. 查看结果    │
│  - 控制台指标   │
│  - 可视化图表   │
│  - 交易日志     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  5. 分析优化    │
│  - 评估表现     │
│  - 调整参数     │
│  - 重新测试     │
└─────────────────┘
```

### 程序运行的6个步骤

执行 `python main.py` 后，程序按以下步骤运行：

#### 步骤 1/6: 初始化模块
```
📦 [步骤 1/6] 初始化模块...
----------------------------------------------------------------------
[策略层] 初始化 DualMovingAverage 策略
  短期均线: 10 日
  长期均线: 30 日
[回测层] 初始化回测引擎
  初始资金: ¥100,000.00
  ...
```

**说明**：加载配置，创建各模块实例

#### 步骤 2/6: 获取股票数据
```
📊 [步骤 2/6] 获取股票数据...
----------------------------------------------------------------------
[数据层] 开始获取数据: ['000001.SZ']
[数据层] 从 yfinance 下载数据...
  正在获取 000001.SZ 的数据...
  获取到 423 条记录
```

**说明**：
- 首次运行会下载数据（可能需要1-2分钟）
- 后续运行直接从缓存读取（秒级）

#### 步骤 3/6: 生成交易信号
```
💡 [步骤 3/6] 生成交易信号...
----------------------------------------------------------------------
[策略层] 开始生成交易信号...
[策略层] 信号生成完成
  买入信号数: 8
  卖出信号数: 8
```

**说明**：根据策略逻辑计算买卖信号点

#### 步骤 4/6: 执行回测
```
⚙️  [步骤 4/6] 执行回测...
----------------------------------------------------------------------
[回测层] 开始回测...
[回测层] 回测完成
  交易次数: 16
  初始资金: ¥100,000.00
  最终资金: ¥103,401.60
  总收益率: 3.40%
```

**说明**：模拟真实交易，计算每笔交易的成本和收益

#### 步骤 5/6: 分析回测结果
```
📈 [步骤 5/6] 分析回测结果...
----------------------------------------------------------------------
[分析层] 计算性能指标...
============================================================
📊 回测性能报告
============================================================
...
```

**说明**：计算各项性能指标，打印详细报告

#### 步骤 6/6: 生成图表和报告
```
📊 [步骤 6/6] 生成图表和报告...
----------------------------------------------------------------------
[分析层] 生成可视化图表...
[分析层] 图表已保存: ./output\backtest_result_000001.SZ_*.png
[分析层] 交易日志已保存: ./output\trade_log_000001.SZ_*.csv
```

**说明**：
- 生成3张子图的综合分析图表
- 保存详细的交易记录CSV

---

## 结果解读

### 控制台输出解读

#### 1. 资金情况
```
💰 资金情况:
  初始资金: ¥100,000.00
  最终资金: ¥103,401.60
  总收益: ¥3,401.60
```

**解读**：
- 用10万元本金
- 最终变成10.34万元
- 净赚3,401.60元

#### 2. 收益指标
```
📈 收益指标:
  总收益率: 3.40%
  年化收益率: 2.16%
```

**解读**：
- **总收益率** 3.40%：整个回测期间的累计收益
- **年化收益率** 2.16%：换算成每年的平均收益率
  - <0% - 亏损
  - 0-5% - 较低
  - 5-10% - 一般
  - 10-15% - 良好
  - >15% - 优秀

#### 3. 风险指标
```
📉 风险指标:
  日波动率: 0.94%
  年化波动率: 14.99%
  最大回撤: -10.66%
  最大回撤持续: 128 天
```

**解读**：
- **日波动率** 0.94%：每天资产波动的标准差
- **年化波动率** 14.99%：波动率的年化值，代表风险水平
  - <10% - 低风险
  - 10-20% - 中等风险
  - >20% - 高风险
- **最大回撤** -10.66%：从峰值到谷底的最大跌幅
  - <10% - 优秀
  - 10-20% - 良好
  - 20-30% - 一般
  - >30% - 需改进
- **最大回撤持续** 128天：从峰值到恢复的最长时间

#### 4. 风险调整收益
```
⚖️ 风险调整收益:
  夏普比率: 0.021
  卡玛比率: 0.203
```

**解读**：
- **夏普比率**：单位风险的超额收益
  - <0 - 表现差于无风险收益
  - 0-1 - 一般
  - 1-2 - 良好
  - >2 - 优秀
- **卡玛比率**：收益与最大回撤的比值
  - 越高越好
  - >1.0 表示收益超过回撤

#### 5. 交易统计
```
🎯 交易统计:
  胜率: 13.99%
  盈亏比: 1.623
  平均盈利: 1.34%
  平均亏损: 0.83%
```

**解读**：
- **胜率** 13.99%：盈利天数占比
  - >50% 为良好
- **盈亏比** 1.623：平均盈利/平均亏损
  - >1.5 为良好
  - >2.0 为优秀
- 注意：胜率低但盈亏比高也可能是好策略

---

### 图表解读

回测系统生成的图表包含3个子图：

#### 图1: 价格走势与交易信号
```
┌──────────────────────────────┐
│  收盘价（黑线）               │
│  短期均线（蓝线）             │
│  长期均线（红线）             │
│  ▲ 买入点（红色向上箭头）     │
│  ▼ 卖出点（绿色向下箭头）     │
└──────────────────────────────┘
```

**如何看**：
- 观察买卖点是否合理
- 金叉（蓝线上穿红线）后出现买入信号
- 死叉（蓝线下穿红线）后出现卖出信号

#### 图2: 资产曲线对比
```
┌──────────────────────────────┐
│  策略收益（蓝色实线）         │
│  买入持有（灰色虚线）         │
└──────────────────────────────┘
```

**如何看**：
- 蓝线在灰线上方 = 策略跑赢买入持有
- 蓝线在灰线下方 = 策略跑输买入持有
- 蓝线更平滑 = 波动更小、风险更低

#### 图3: 回撤曲线
```
┌──────────────────────────────┐
│  0% ─────────────────────── │
│      ╲                       │
│       ╲  红色填充区域        │
│        ╲                     │
│  -10%   ▼ 最大回撤点         │
└──────────────────────────────┘
```

**如何看**：
- 红色区域越小 = 回撤越小 = 风险越低
- 关注最大回撤点的深度和持续时间

---

### 交易日志CSV解读

CSV文件包含所有交易记录：

| 列名 | 说明 |
|------|------|
| date | 交易日期 |
| action | 操作类型（BUY/SELL） |
| price | 成交价格 |
| shares | 股数 |
| cost | 买入成本 |
| revenue | 卖出收入 |
| commission | 手续费 |
| stamp_duty | 印花税 |
| total | 实际花费/收入 |
| cash_after | 交易后现金余额 |

**用途**：
- 详细审查每笔交易
- 计算单笔盈亏
- 发现异常交易
- Excel进一步分析

---

## 常见问题

### Q1: 运行时提示"没有成功获取任何股票数据"

**原因**：
- 网络连接问题
- 股票代码格式错误
- 数据源服务异常

**解决方案**：
```bash
# 1. 先测试数据源
python test_akshare.py

# 2. 如果akshare失败，切换到yfinance
# 修改 config.py:
DATA_CONFIG = {
    'data_source': 'yfinance',  # 改为yfinance
}

# 3. 检查股票代码格式
# A股代码格式：
# - 深圳：000001.SZ
# - 上海：600000.SH
```

### Q2: 图表中文显示乱码

**解决方案**：

1. **Windows系统**：
```python
# 修改 analyzer.py 中的字体设置
plt.rcParams['font.sans-serif'] = ['Microsoft YaHei']
```

2. **Mac系统**：
```python
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS']
```

3. **Linux系统**：
```bash
# 安装中文字体
sudo apt-get install fonts-wqy-zenhei

# 然后在 analyzer.py 中设置
plt.rcParams['font.sans-serif'] = ['WenQuanYi Zen Hei']
```

### Q3: 回测结果不理想，如何改进？

**优化建议**：

1. **调整均线周期**：
   - 短期均线: 5-20日
   - 长期均线: 20-120日
   - 保持 长期/短期 > 2

2. **优化资金管理**：
```python
BACKTEST_CONFIG = {
    'position_size': 0.5,  # 改为半仓，降低风险
}
```

3. **添加过滤条件**：
   - 只在上涨趋势中交易
   - 增加成交量确认
   - 设置止损止盈

4. **尝试其他策略**：
```python
STRATEGY_CONFIG = {
    'strategy_name': 'RSI',  # 切换到RSI策略
}
```

### Q4: 首次运行很慢

**原因**：首次需要下载历史数据

**解决方案**：
- 耐心等待（通常1-2分钟）
- 数据会自动缓存，后续秒开
- 可以缩短时间范围测试：
```python
DATA_CONFIG = {
    'start_date': '2024-01-01',  # 只测试1年
    'end_date': '2024-10-01',
}
```

### Q5: 如何运行多只股票？

**当前限制**：一次只支持一只股票

**临时方案**：
1. 修改配置，运行第一只
2. 记录结果
3. 修改配置，运行第二只
4. 对比结果

**未来扩展**：可编写循环脚本自动测试多只股票

---

## 最佳实践

### 1. 参数优化策略

**不要过度拟合**：
- ❌ 错误：测试100种参数组合，选最好的
- ✅ 正确：选3-5种常用参数，验证稳定性

**样本外测试**：
```python
# 在2020-2022年优化参数
# 在2023-2024年验证效果
```

### 2. 回测的局限性

**注意事项**：
- 历史数据不代表未来
- 回测不考虑极端行情（如停牌、跌停）
- 实盘滑点可能更大
- 回测结果通常优于实盘

### 3. 记录和管理

**建议**：
```
创建实验记录表格：
┌──────┬─────────┬────────┬────────┬────────┐
│ 日期 │ 股票    │ 策略   │ 参数   │ 收益率 │
├──────┼─────────┼────────┼────────┼────────┤
│ 10-28│ 000001  │ 双均线 │ 10/30  │ 3.4%   │
│ 10-28│ 600519  │ 双均线 │ 10/30  │ 8.2%   │
└──────┴─────────┴────────┴────────┴────────┘
```

### 4. 持续改进

**迭代流程**：
```
测试 → 分析 → 优化 → 再测试
  ↑                    ↓
  └──── 循环改进 ──────┘
```

---

## 附录：命令速查表

| 命令 | 说明 | 用途 |
|------|------|------|
| `python main.py` | 运行回测 | 主要命令 |
| `python test_akshare.py` | 测试数据源 | 诊断问题 |
| `pip install -r requirements.txt` | 安装依赖 | 初始化 |
| `rm -rf data/cache/*` | 清理缓存 | 更新数据 |

---

**祝你使用愉快！有问题随时查阅本手册。** 📊💡

*最后更新：2025-10-28*
